ТЕХНИЧЕСКОЕ ЗАДАНИЕ: Гибридная система мониторинга (Telethon + aiogram)
1. Общее описание и Архитектура
Цель: Автоматизированный контроль 30 корпоративных чатов, включая анализ контента за прошедший период и полную сверку состава участников.
Концепция «Разделения ответственности»:
1. Collector (Telethon/Userbot): Сервисный аккаунт (не личный аккаунт сотрудника!), работающий на протоколе MTProto.
    ◦ Задачи: Молчаливое чтение истории сообщений за 6 часов, скачивание голосовых, получение полного списка участников.
    ◦ Преимущество: Видит историю «задним числом» и всех участников (даже молчунов).
2. Manager (aiogram/Bot): Официальный бот.
    ◦ Задачи: Отправка уведомлений администратору, прием команд (/status, /scan), интерфейс с кнопками (Inline Keyboards).
    ◦ Преимущество: Не имеет лимитов на отправку сообщений юзерам, выглядит профессионально, исключает риск бана Userbot'а за рассылку спама в ЛС.
3. Storage (SQLite + Google Sheets):
    ◦ SQLite: Промежуточный буфер для дедупликации сообщений и хранения состояния (предотвращение потери данных при сбое Sheets).
    ◦ Google Sheets: Панель управления (конфиг) и итоговые отчеты.

--------------------------------------------------------------------------------
2. Функциональные требования
2.1. Модуль сбора данных (Collector)
• Режим работы: Запуск по расписанию (APScheduler) каждые 6 часов.
• Сбор сообщений: Использует метод iter_messages с параметром offset_date (текущее время минус 6 часов).
• Сбор участников: Использует метод get_participants для получения полного списка пользователей в чате (включая ID и Username) для сверки с Whitelist.
• Медиа: Скачивает голосовые сообщения. Реализовать защиту от зависания: таймаут на скачивание и лимит размера файла (например, до 50 МБ), несмотря на требование «без ограничений», чтобы не заблокировать цикл.
2.2. Модуль анализа (Core Logic)
• Whisper (STT): Голосовые отправляются в CometAPI (Whisper). Полученный текст добавляется к анализируемому массиву.
• LLM Анализ:
    ◦ Чанкинг (Batching): Массив сообщений разбивается на пакеты (по 50–100 шт. или 4000 токенов), чтобы не превысить контекстное окно модели.
    ◦ Промпт: Отправляется в CometAPI. Включает JSON-схему ответа для строгой валидации.
• Сверка участников:
    ◦ Недостающие: Сравнивает allowed_chats из Google Sheets с реальным списком get_participants.
    ◦ Лишние: Находит пользователей в чате, которых нет в allowed_chats и whitelist.
2.3. Модуль отчетности (Manager & Storage)
• Google Sheets:
    ◦ Режим записи: Append-only (добавление строк) или архивация перед очисткой, чтобы избежать потери истории между циклами.
    ◦ Листы: «Подозрительные», «Участники», «Логи».
• Уведомления (aiogram):
    ◦ Отправляет карточки инцидентов в ЛС админу.
    ◦ Добавляет кнопки: [Ложное срабатывание] / [Подтвердить].
    ◦ Сводный отчет: «Проверено 30 чатов, найдено 5 нарушений, 2 лишних участника».
2.4. Безопасность и Anti-Flood
• Задержки: Между обработкой чатов в Telethon вставляется asyncio.sleep(random(10, 30)) во избежание ошибки FloodWait.
• Сессия: Файл сессии Telethon не передается в репозиторий (добавлен в .gitignore).
• Изоляция: Для Userbot используется отдельный (технический) аккаунт Telegram, а не личный аккаунт директора.

--------------------------------------------------------------------------------
3. Стек и Библиотеки
В соответствии с рекомендациями, используется Python 3.11+.
Структура requirements.txt
# --- Telegram Core ---
# Для работы Userbot (сбор данных)
Telethon>=1.34.0
# Для работы официального бота (уведомления)
aiogram>=3.4.0

# --- Asynchronous & Scheduling ---
# Планировщик задач
APScheduler>=3.10.4
# Асинхронные запросы (для CometAPI/Whisper)
aiohttp>=3.9.0

# --- Data & Storage ---
# Работа с Google Sheets
gspread_asyncio>=1.4.0
google-auth>=2.28.0
# Валидация данных и настроек
pydantic>=2.6.0
pydantic-settings>=2.2.0
# Работа с локальной БД (SQLite драйвер встроен, но можно добавить aiosqlite)
aiosqlite>=0.20.0

# --- Utilities ---
# Загрузка переменных окружения
python-dotenv>=1.0.1
# Логирование
loguru>=0.7.2

--------------------------------------------------------------------------------
4. Структура проекта
Предлагаемая структура папок для гибридной схемы:
telegram-monitor/
├── config/
│   ├── .env                    # Токены, API keys (НЕ в git)
│   ├── service_account.json    # Ключи Google Cloud (НЕ в git)
│   └── settings.py             # Pydantic модели конфигурации
├── data/
│   ├── sessions/               # Папка для .session файлов Telethon (НЕ в git)
│   ├── local_db.sqlite         # Локальный кэш и буфер сообщений
│   └── temp/                   # Временная папка для голосовых файлов
├── src/
│   ├── collector/              # Модуль Telethon
│   │   ├── client.py           # Инициализация Userbot
│   │   ├── history.py          # Логика iter_messages
│   │   └── participants.py     # Логика get_participants
│   ├── manager/                # Модуль aiogram
│   │   ├── bot.py              # Инициализация Bot
│   │   ├── handlers.py         # Команды /status, /force_scan
│   │   └── notifier.py         # Формирование алертов админу
│   ├── core/                   # Бизнес-логика
│   │   ├── analyzer.py         # Оркестратор анализа
│   │   ├── llm_client.py       # Интеграция с CometAPI
│   │   └── whisper.py          # Интеграция с STT
│   ├── storage/
│   │   ├── sheets.py           # Чтение/Запись Google Sheets
│   │   └── database.py         # CRUD для SQLite
│   └── utils/
│       └── logger.py           # Настройка Loguru
├── main.py                     # Точка входа (запуск Scheduler и Bot polling)
├── requirements.txt
└── README.md
5. Конфигурация (.env)
Файл .env должен содержать учетные данные для обеих сущностей Telegram:
# --- Telethon (Сборщик) ---
# Получить на my.telegram.org
TG_API_ID=12345678
TG_API_HASH=abcdef1234567890...
# Телефон сервисного аккаунта (для первого входа)
TG_PHONE=+79001234567

# --- Aiogram (Уведомления) ---
# Получить у BotFather
BOT_TOKEN=777777777:AAH...
ADMIN_ID=123456789

# --- Services ---
COMET_API_KEY=sk-...
COMET_API_URL=https://...
GOOGLE_SHEETS_ID=1A2B3C...

# --- App Settings ---
SCAN_INTERVAL_HOURS=6
MAX_MESSAGES_PER_CHUNK=50